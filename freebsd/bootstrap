#!/usr/bin/env bash

set -eu

echo "************************************************"
echo "* Setting up a new FreeBSD 13.0 workstation... *"
echo "************************************************"

# echo "***********************************"
# echo "* Updating configuration files... *"
# echo "***********************************"

# mkdir -p /usr/local/etc/pkg/repos
# echo 'FreeBSD: { url: "pkg+http://pkg.FreeBSD.org/${ABI}/latest" }' > /usr/local/etc/pkg/repos/FreeBSD.conf

echo "********************************"
echo "* Upgrading system packages... *"
echo "********************************"

pkg update
pkg upgrade -y

echo "******************************"
echo "* Installing new packages... *"
echo "******************************"

pkg install -y 1password-client alacritty curl dbus doas feh firefox fish fzf git gmake \
  gnupg htop i3 i3lock jq keepassxc mc mosh neovim nerd-fonts nvidia-driver p7zip paratype \
  pcmanfm polybar ripgrep rofi rsync scrot taskwarrior thunderbird tmux vifm wget xdm xorg

echo "**********************"
echo "* Setting up user... *"
echo "**********************"

pw usermod arg -G wheel,video -s /usr/local/bin/fish

echo "***********************************"
echo "* Updating configuration files... *"
echo "***********************************"

echo "PermitRootLogin no" >> /etc/ssh/sshd_config
echo "IgnoreUserKnownHosts yes" >> /etc/ssh/sshd_config
echo "PasswordAuthentication no" >> /etc/ssh/sshd_config
echo "PermitTunnel no" >> /etc/ssh/sshd_config
echo "AllowAgentForwarding no" >> /etc/ssh/sshd_config
echo "AllowTcpForwarding no" >> /etc/ssh/sshd_config
echo "X11Forwarding no" >> /etc/ssh/sshd_config
echo "AllowUsers arg" >> /etc/ssh/sshd_config

echo "permit nopass keepenv :wheel" >> /usr/local/etc/doas.conf

mkdir -p /etc/X11
curl -sLS -o /etc/X11/xorg.conf "https://raw.githubusercontent.com/arg/dotfiles/master/freebsd/etc/X11/xorg.conf"

sysrc xdm_enable=YES
sysrc ntpdate_enable=YES
sysrc ntpdate_hosts="es.pool.ntp.org"
sysrc kld_list+="nvidia-modeset"

echo "**********************************************************************************"
echo "* Everything done. Press <Return> to reboot the machine with new settings.       *"
echo "* After reboot, install dotfiles by 'arg' user (see Readme for the instruction). *"
echo "**********************************************************************************"
read

reboot
