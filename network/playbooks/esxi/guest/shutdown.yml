- name: "Shutdown ESXi guests"
  hosts: "localhost"
  gather_facts: false
  vars_files:
    - "../../secrets.yml"
  tasks:
    - name: "Shutdown guest"
      community.vmware.vmware_guest_powerstate:
        hostname: "{{ esxi.hostname }}"
        username: "{{ esxi.username }}"
        password: "{{ esxi.password }}"
        validate_certs: false
        state: "shutdown-guest"
        state_change_timeout: 10
        name: "{{ item }}"
      with_items: "{{ groups['virtual_machines'] }}"
